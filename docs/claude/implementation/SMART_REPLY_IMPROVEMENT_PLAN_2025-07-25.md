# Smart Reply改善計画
**作成日**: 2025-07-25  
**作成者**: Claude Code (Opus 4)  
**目的**: UXレビューフィードバックに基づく改善実装計画

## 概要

Smart Reply機能の基本実装は完了しましたが、UXレビューおよびユーザーフィードバックから重要な改善点が明らかになりました。本計画書では、改善項目を優先度順に整理し、実装計画を提示します。

## 改善項目一覧

### Phase 1: 即座に実装すべき改善（2-3時間）

#### 1.1 既読ボタンのフェードアウト効果
- **優先度**: ★★★ 高
- **実装時間**: 0.5時間
- **影響範囲**: `/mention`コマンドのUI
- **実装内容**:
  ```typescript
  // mentionRoutes.ts
  - 既読ボタン押下時にresponse_urlを使用してメッセージ更新
  - 該当メンション行をグレーアウト（opacity: 0.5）
  - 1秒後に行を削除してメッセージを再構築
  ```
- **効果**: ユーザーに視覚的フィードバックを提供し、達成感を演出

#### 1.2 /todo表示のセクション分割
- **優先度**: ★★★ 高
- **実装時間**: 1.5時間
- **影響範囲**: `/todo`コマンドの表示
- **実装内容**:
  ```typescript
  // index.ts
  - [TASKS]セクション: 純粋なタスクのみ表示（最大5件）
  - [MENTIONS]セクション: 未対応メンションのみ表示（最大3件）
  - それぞれ独立したheaderとdividerで区切る
  - メンション由来のタスクは[TASKS]には表示しない
  ```
- **効果**: 情報の整理による認知負荷の大幅削減

#### 1.3 スレッドジャンプの1クリック化
- **優先度**: ★★☆ 中
- **実装時間**: 0.5時間
- **影響範囲**: Smart Reply UIのボタン
- **実装内容**:
  ```typescript
  // SmartReplyUIBuilder.ts
  - 「スレッドで返信する」ボタンを直接URLボタンに変更
  - thread_reply_jumpアクションハンドラーを削除
  - ボタンに直接permalinkを設定
  ```
- **効果**: 操作ステップを2から1に削減

### Phase 2: 次の作業セッションで実装（3-4時間）

#### 2.1 タスク重複防止機能
- **優先度**: ★★★ 高
- **実装時間**: 2時間
- **影響範囲**: データベース、タスク作成ロジック
- **実装内容**:
  ```typescript
  // 1. Prismaスキーマ更新
  model Task {
    @@unique([slackTs, channelId, status]) // 完了済みは除外
  }
  
  // 2. taskService.ts
  - createTaskFromMention()でfindFirst実装
  - 既存の未完了タスクがあればエラー
  - 完了済みなら新規作成可能
  ```
- **効果**: データ整合性の向上、無駄なタスクの防止

#### 2.2 スレッド内メンション検知
- **優先度**: ★★☆ 中
- **実装時間**: 1時間
- **影響範囲**: quickReplyHandler.ts
- **実装内容**:
  ```typescript
  // quickReplyHandler.ts
  - event.thread_tsが存在する場合の処理追加
  - スレッド内メンションもInboxItemに保存
  - threadTsフィールドを活用
  ```
- **効果**: メンション検知の完全性向上

#### 2.3 メンション状態管理の改善
- **優先度**: ★★☆ 中
- **実装時間**: 1時間
- **影響範囲**: mentionService.ts
- **実装内容**:
  ```typescript
  // InboxItemに以下のフィールドを活用
  - hasReplied: 返信済みフラグ
  - isTaskCreated: タスク化済みフラグ
  - taskId: 作成されたタスクのID
  ```
- **効果**: メンションのライフサイクル管理向上

### Phase 3: 別タスクとして計画（Phase 1.5）

#### 3.1 User Token (xoxp) オプトイン実装
- **優先度**: ★★☆ 中（将来的には高）
- **実装時間**: 8-10時間
- **影響範囲**: OAuth、データベース、メンション検索
- **実装内容**:
  ```typescript
  // 新規実装項目
  1. OAuth scopeの追加
     - channels:history
     - groups:history
     - im:history
     - search:read（有料プランのみ）
  
  2. SlackInstallationテーブル拡張
     - userToken: String?
     - userTokenScopes: String[]
  
  3. /mention enhanceコマンド
     - User Token接続フロー案内
     - 接続後は72時間履歴検索可能
  
  4. mentionService拡張
     - User Token利用可能時はsearch.messages API使用
     - 不可能時は現在のEvent API方式
  ```
- **効果**: 過去72時間のメンション完全把握

#### 3.2 タスク完了→既読自動反映
- **優先度**: ★☆☆ 低
- **実装時間**: 2時間
- **影響範囲**: taskService.ts、mentionService.ts
- **実装内容**:
  ```typescript
  // taskService.onTaskCompleted()
  - タスクのメタデータからslackTs取得
  - 対応するInboxItemを既読に更新
  - メンション一覧から自動的に消える
  ```
- **効果**: ワークフローの自動化

## 実装スケジュール

### 今すぐ（2025-07-25）
1. Phase 1の全項目を実装（2-3時間）
   - 既読フェードアウト
   - /todo分割
   - 1クリック化

### 次回セッション（2025-07-26予定）
2. Phase 2の全項目を実装（3-4時間）
   - タスク重複防止
   - スレッド内メンション
   - 状態管理改善

### 別スプリント（Task 10.9として）
3. Phase 3のUser Token実装（8-10時間）
   - 設計ドキュメント作成
   - セキュリティレビュー
   - 段階的実装

## リスクと対策

### リスク1: 既読フェードアウトの実装複雑性
- **対策**: response_urlを使用したメッセージ更新で対応
- **代替案**: 単純な「既読にしました」メッセージ表示

### リスク2: タスク重複防止の過度な制限
- **対策**: 完了済みタスクの再作成は許可
- **ユーザー通知**: 「このメンションは既にタスク化されています」

### リスク3: User Token管理のセキュリティ
- **対策**: 暗号化保存、定期的なトークンリフレッシュ
- **オプトイン方式**: 必要な人だけが接続

## 成功指標

1. **Phase 1完了後**:
   - 既読操作の満足度向上
   - /todo表示の視認性向上50%
   - 操作ステップ削減による効率化

2. **Phase 2完了後**:
   - タスク重複ゼロ
   - メンション検知率100%（参加チャンネル内）
   - 状態管理の一貫性確保

3. **Phase 3完了後**:
   - 72時間メンション履歴の完全取得
   - ワークフロー自動化による操作削減30%

## まとめ

本改善計画により、Smart Reply機能は基本的な動作から洗練されたUXへと進化します。Phase 1-2は即座に実装可能で、大きな効果が期待できます。Phase 3は慎重な設計が必要ですが、実装後の価値は非常に高いと考えられます。

---

**次のアクション**: Phase 1の実装開始承認をお待ちしています。